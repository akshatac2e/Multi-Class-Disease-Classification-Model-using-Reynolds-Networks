# ğŸ—ï¸ Production-Grade Blood Cell Analysis Architecture

## High-Level Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lab Image  â”‚â”€â”€â”€â”€â–ºâ”‚ Ingestion APIâ”‚â”€â”€â”€â”€â–ºâ”‚ Preprocessor â”‚â”€â”€â”€â”€â–ºâ”‚  Segmentation  â”‚
â”‚ (Variable)  â”‚     â”‚  (Validator) â”‚     â”‚  (Stain Norm)â”‚     â”‚     Engine     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                        â”‚
                                                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Structured  â”‚â—„â”€â”€â”€â”€â”‚  Aggregator  â”‚â—„â”€â”€â”€â”€â”‚ Dual-Head    â”‚â—„â”€â”€â”€â”€â”‚ ROI Extractor  â”‚
â”‚    Report    â”‚     â”‚    (NMS)     â”‚     â”‚ Classifiers  â”‚     â”‚   & Router     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”œâ”€â”€â–º RBC Classifier (Stream A)
                                                  â””â”€â”€â–º WBC Classifier (Stream B)
```

---

## ğŸ” Detailed Pipeline Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STAGE 1: DATA INGESTION & PREPROCESSING                       â”‚
â”‚                         (The "Generalizable" Layer)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input: Lab Microscopy Images (Variable Quality & Resolution)                     â”‚
â”‚  â€¢ Different labs: varying lighting, stain quality, resolutions                  â”‚
â”‚  â€¢ File formats: WSI (40kÃ—40k), TIFF, PNG, JPEG                                  â”‚
â”‚  â€¢ Color variations: Different Giemsa/Wright stain protocols                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.1 Input Validator                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Checks:                                                  â”‚    â”‚
â”‚  â”‚  âœ“ File integrity (not corrupted)                       â”‚    â”‚
â”‚  â”‚  âœ“ Metadata validation (resolution, color space)        â”‚    â”‚
â”‚  â”‚  âœ“ Resolution requirements (min 1000Ã—1000 pixels)       â”‚    â”‚
â”‚  â”‚  âœ“ File format support                                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Actions:                                                 â”‚    â”‚
â”‚  â”‚  â€¢ Reject corrupted files immediately                   â”‚    â”‚
â”‚  â”‚  â€¢ Log validation errors with details                   â”‚    â”‚
â”‚  â”‚  â€¢ Return validation status + error codes               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.2 Stain Normalization                                          â”‚
â”‚     â˜… CRUCIAL FOR GENERALIZABILITY â˜…                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Purpose: Neutralize variations in lab staining protocolsâ”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Techniques (Choose One):                                â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ A) Macenko Normalization:                               â”‚    â”‚
â”‚  â”‚    â€¢ Decompose image into H&E channels                  â”‚    â”‚
â”‚    â”‚    â€¢ Estimate stain vectors via SVD                     â”‚    â”‚
â”‚  â”‚    â€¢ Reconstruct with target stain vectors              â”‚    â”‚
â”‚  â”‚    â€¢ Fast, deterministic                                â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ B) Vahadane Normalization:                              â”‚    â”‚
â”‚  â”‚    â€¢ Use sparse non-negative matrix factorization       â”‚    â”‚
â”‚  â”‚    â€¢ Better handles multi-stain images                  â”‚    â”‚
â”‚  â”‚    â€¢ More accurate, slightly slower                     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ C) Reinhard Color Transfer:                             â”‚    â”‚
â”‚  â”‚    â€¢ Match mean and std of LAB channels                 â”‚    â”‚
â”‚  â”‚    â€¢ Simpler, works for basic normalization             â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Implementation:                                          â”‚    â”‚
â”‚  â”‚   1. Convert RGB â†’ Optical Density (OD)                 â”‚    â”‚
â”‚  â”‚   2. Separate stain components                          â”‚    â”‚
â”‚  â”‚   3. Normalize to reference template                    â”‚    â”‚
â”‚  â”‚   4. Reconstruct normalized RGB                         â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Example: One lab's "bluer" Giemsa â†’ Reference stain     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Benefits:                                                â”‚    â”‚
â”‚  â”‚   âœ“ Works across different labs without retraining      â”‚    â”‚
â”‚  â”‚   âœ“ Reduces color-based domain shift                    â”‚    â”‚
â”‚  â”‚   âœ“ Improves model generalization 15-20%                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.3 Adaptive Tiling/Patching                                     â”‚
â”‚     (For High-Resolution Images: 40kÃ—40k pixels)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Problem: Cannot process 40kÃ—40k images at once          â”‚    â”‚
â”‚  â”‚ Solution: Intelligent tiling with overlap               â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Algorithm:                                               â”‚    â”‚
â”‚  â”‚  1. Slice image into overlapping tiles                  â”‚    â”‚
â”‚  â”‚     â€¢ Tile size: 1024Ã—1024 pixels                       â”‚    â”‚
â”‚  â”‚     â€¢ Overlap: 10-20% (100-200 pixels)                  â”‚    â”‚
â”‚  â”‚     â€¢ Prevents cutting cells at boundaries              â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  2. Background Tile Detection (Optimization):           â”‚    â”‚
â”‚  â”‚     â€¢ Calculate tissue density per tile                 â”‚    â”‚
â”‚  â”‚     â€¢ If density < 5%, mark as "background-only"        â”‚    â”‚
â”‚  â”‚     â€¢ Discard background tiles to save compute          â”‚    â”‚
â”‚  â”‚     â€¢ Typical savings: 40-60% of tiles                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  3. Quality Filtering:                                   â”‚    â”‚
â”‚  â”‚     â€¢ Check focus/blur (Laplacian variance)             â”‚    â”‚
â”‚  â”‚     â€¢ Reject out-of-focus tiles (variance < threshold)  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Visual Example:                                          â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”‚
â”‚  â”‚   â”‚ [Tile1][Tile2][Tile3]               â”‚              â”‚    â”‚
â”‚  â”‚   â”‚   â†“â†“    â†“â†“    â†“â†“                    â”‚              â”‚    â”‚
â”‚  â”‚   â”‚ [Overlap Area]                      â”‚              â”‚    â”‚
â”‚  â”‚   â”‚ [Tile4][Tile5][Tile6]               â”‚              â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Output: List of valid tiles with coordinates            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
Output: Normalized, tiled images ready for segmentation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Format: List[(tile_image, x_offset, y_offset, tile_id)]         â”‚
â”‚ Each tile: (1024, 1024, 3) normalized RGB [0, 1]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STAGE 2: UNIVERSAL SEGMENTATION ENGINE                        â”‚
â”‚                         (The "Robust" Layer)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Purpose: Single heavy-duty model to locate and mask EVERY cell

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2.1 Model Architecture Selection                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Requirement: INSTANCE SEGMENTATION (not just semantic)  â”‚    â”‚
â”‚  â”‚             Must separate touching/overlapping cells    â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Architecture Options:                                    â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Option A: Hybrid Task Cascade (HTC) â˜… RECOMMENDED       â”‚    â”‚
â”‚  â”‚   â€¢ Multi-stage refinement architecture                 â”‚    â”‚
â”‚  â”‚   â€¢ Excellent at separating touching cells              â”‚    â”‚
â”‚  â”‚   â€¢ Higher accuracy, moderate speed                     â”‚    â”‚
â”‚  â”‚   â€¢ Best for production quality                         â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Option B: Swin Transformer-based Mask R-CNN             â”‚    â”‚
â”‚  â”‚   â€¢ Vision transformer backbone                         â”‚    â”‚
â”‚  â”‚   â€¢ Better global context understanding                 â”‚    â”‚
â”‚  â”‚   â€¢ State-of-the-art accuracy                           â”‚    â”‚
â”‚  â”‚   â€¢ Higher compute requirements                         â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Option C: YOLOv11-seg â˜… REAL-TIME PRIORITY              â”‚    â”‚
â”‚  â”‚   â€¢ Fastest inference speed                             â”‚    â”‚
â”‚  â”‚   â€¢ Single-stage detector + segmentation                â”‚    â”‚
â”‚  â”‚   â€¢ Good accuracy with 10-20Ã— speed gain                â”‚    â”‚
â”‚  â”‚   â€¢ Best for real-time/edge deployment                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Why NOT Standard U-Net?                                  â”‚    â”‚
â”‚  â”‚   âœ— Fails to separate touching RBC clumps               â”‚    â”‚
â”‚  â”‚   âœ— Only does semantic segmentation (not instance)      â”‚    â”‚
â”‚  â”‚   âœ— Cannot count individual cells accurately            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2.2 Model Structure (HTC Example)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Input: Tile (1024Ã—1024Ã—3)                               â”‚    â”‚
â”‚  â”‚        â†“                                                 â”‚    â”‚
â”‚  â”‚ Backbone: ResNet-50 or Swin-T                           â”‚    â”‚
â”‚  â”‚   â€¢ Extract multi-scale features                        â”‚    â”‚
â”‚  â”‚   â€¢ FPN (Feature Pyramid Network) for different scales  â”‚    â”‚
â”‚  â”‚        â†“                                                 â”‚    â”‚
â”‚  â”‚ RPN (Region Proposal Network)                           â”‚    â”‚
â”‚  â”‚   â€¢ Generate ~2000 region proposals                     â”‚    â”‚
â”‚  â”‚   â€¢ Filter to top 300 by confidence                     â”‚    â”‚
â”‚  â”‚        â†“                                                 â”‚    â”‚
â”‚  â”‚ Stage 1: Coarse Detection                               â”‚    â”‚
â”‚  â”‚   â€¢ Bounding box regression                             â”‚    â”‚
â”‚  â”‚   â€¢ Class prediction (Background/RBC/WBC)               â”‚    â”‚
â”‚  â”‚   â€¢ Coarse mask prediction                              â”‚    â”‚
â”‚  â”‚        â†“                                                 â”‚    â”‚
â”‚  â”‚ Stage 2: Refinement                                     â”‚    â”‚
â”‚  â”‚   â€¢ Refine bounding boxes                               â”‚    â”‚
â”‚  â”‚   â€¢ Improve class scores                                â”‚    â”‚
â”‚  â”‚   â€¢ Refine segmentation masks                           â”‚    â”‚
â”‚  â”‚        â†“                                                 â”‚    â”‚
â”‚  â”‚ Stage 3: Final Refinement                               â”‚    â”‚
â”‚  â”‚   â€¢ High-precision masks                                â”‚    â”‚
â”‚  â”‚   â€¢ Separate touching cells                             â”‚    â”‚
â”‚  â”‚   â€¢ Final classification scores                         â”‚    â”‚
â”‚  â”‚        â†“                                                 â”‚    â”‚
â”‚  â”‚ Output per Detection:                                    â”‚    â”‚
â”‚  â”‚   â€¢ Bounding box: (x1, y1, x2, y2)                      â”‚    â”‚
â”‚  â”‚   â€¢ Binary mask: (H, W) for each instance               â”‚    â”‚
â”‚  â”‚   â€¢ Class ID: 0=Background, 1=RBC, 2=WBC                â”‚    â”‚
â”‚  â”‚   â€¢ Confidence score: [0, 1]                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2.3 Output Format                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Classes: 3-class prediction                             â”‚    â”‚
â”‚  â”‚   â€¢ Class 0: Background                                 â”‚    â”‚
â”‚  â”‚   â€¢ Class 1: RBC (Red Blood Cell)                       â”‚    â”‚
â”‚  â”‚   â€¢ Class 2: WBC (White Blood Cell)                     â”‚    â”‚
â”‚  â”‚   â€¢ Optional: Class 3: Platelet (if needed)             â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ For each detected cell:                                 â”‚    â”‚
â”‚  â”‚   {                                                      â”‚    â”‚
â”‚  â”‚     "bbox": [x1, y1, x2, y2],                           â”‚    â”‚
â”‚  â”‚     "mask": binary_mask_array,  # (H, W)                â”‚    â”‚
â”‚  â”‚     "class_id": 1 or 2,                                 â”‚    â”‚
â”‚  â”‚     "confidence": 0.95,                                 â”‚    â”‚
â”‚  â”‚     "tile_id": 42,                                      â”‚    â”‚
â”‚  â”‚     "global_coords": [x_abs, y_abs]  # In original img  â”‚    â”‚
â”‚  â”‚   }                                                      â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Typical Output: 500-2000 cells per tile                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
Performance Metrics:
â”œâ”€ Precision: >0.95 (few false positives)
â”œâ”€ Recall: >0.90 (detect most cells)
â”œâ”€ IoU: >0.85 (accurate masks)
â””â”€ Inference: 100-500ms per tile (GPU)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STAGE 3: ROI EXTRACTION & DYNAMIC ROUTING                      â”‚
â”‚                    (The "Traffic Controller" Layer)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Purpose: Clean detections and route to appropriate classifiers

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.1 Filter & Clean                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Quality Filtering Pipeline:                             â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 1. Confidence Threshold:                                â”‚    â”‚
â”‚  â”‚    â€¢ Keep detections with confidence â‰¥ 0.5              â”‚    â”‚
â”‚  â”‚    â€¢ Adjustable based on precision/recall tradeoff      â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 2. Morphological Heuristics:                            â”‚    â”‚
â”‚  â”‚    Remove artifacts based on:                           â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚    a) Area constraints:                                 â”‚    â”‚
â”‚  â”‚       â€¢ Min area: 50 pixels (too small = noise)         â”‚    â”‚
â”‚  â”‚       â€¢ Max area: 50,000 pixels (too large = clump)     â”‚    â”‚
â”‚  â”‚       â€¢ Typical RBC: 400-800 pixels                     â”‚    â”‚
â”‚  â”‚       â€¢ Typical WBC: 1000-3000 pixels                   â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚    b) Aspect Ratio:                                     â”‚    â”‚
â”‚  â”‚       â€¢ Reject if aspect_ratio > 5:1 (elongated debris) â”‚    â”‚
â”‚  â”‚       â€¢ Biological cells are roughly circular           â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚    c) Solidity:                                         â”‚    â”‚
â”‚  â”‚       â€¢ Solidity = Area / Convex_Hull_Area              â”‚    â”‚
â”‚  â”‚       â€¢ Reject if solidity < 0.7 (irregular shape)      â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚    d) Edge Proximity:                                   â”‚    â”‚
â”‚  â”‚       â€¢ Remove cells within 10px of tile edge           â”‚    â”‚
â”‚  â”‚       â€¢ These will be captured in adjacent tile         â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 3. Duplicate Detection:                                 â”‚    â”‚
â”‚  â”‚    â€¢ Same cell detected in overlapping tiles            â”‚    â”‚
â”‚  â”‚    â€¢ Will be resolved later in Stage 5 (NMS)            â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Result: Clean, high-quality detections                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.2 Crop & Pad                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ For each detected cell:                                 â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 1. Extract square crop:                                 â”‚    â”‚
â”‚  â”‚    â€¢ Center on cell centroid                            â”‚    â”‚
â”‚  â”‚    â€¢ Make square (max of width/height)                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 2. Add Context Padding:                                 â”‚    â”‚
â”‚  â”‚    â€¢ Add 20-30% padding around cell                     â”‚    â”‚
â”‚  â”‚    â€¢ Captures surrounding context                       â”‚    â”‚
â”‚  â”‚    â€¢ Prevents edge feature loss                         â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Visual:                                                  â”‚    â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚    â”‚
â”‚  â”‚    â”‚  [Padding]        â”‚                                â”‚    â”‚
â”‚  â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                                â”‚    â”‚
â”‚  â”‚    â”‚   â”‚  Cell   â”‚     â”‚   â† Padding provides context  â”‚    â”‚
â”‚  â”‚    â”‚   â”‚  (Core) â”‚     â”‚                                â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                                â”‚    â”‚
â”‚  â”‚    â”‚  [Padding]        â”‚                                â”‚    â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Robustness Tip: Tight crops remove edge features!       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 3. Boundary Handling:                                    â”‚    â”‚
â”‚  â”‚    â€¢ If crop extends beyond image: reflect padding      â”‚    â”‚
â”‚  â”‚    â€¢ Maintains spatial relationships                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.3 The Router (Dynamic Stream Assignment)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Input: List of cleaned, cropped cells                   â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Routing Logic:                                           â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   IF segmentation_class == 1 (RBC):                     â”‚    â”‚
â”‚  â”‚      â†’ Route to Stream A (RBC Classifier)               â”‚    â”‚
â”‚  â”‚      â†’ Target input size: 64Ã—64 or 128Ã—128              â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   ELSE IF segmentation_class == 2 (WBC):                â”‚    â”‚
â”‚  â”‚      â†’ Route to Stream B (WBC Classifier)               â”‚    â”‚
â”‚  â”‚      â†’ Target input size: 224Ã—224                       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Batching Strategy:                                       â”‚    â”‚
â”‚  â”‚   â€¢ Accumulate cells into batches                       â”‚    â”‚
â”‚  â”‚   â€¢ RBC batch size: 64-128 (smaller images)             â”‚    â”‚
â”‚  â”‚   â€¢ WBC batch size: 16-32 (larger images)               â”‚    â”‚
â”‚  â”‚   â€¢ Process batches asynchronously for efficiency       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚                          â”‚
    â–¼                           â–¼                          â–¼
Stream A: RBC Candidates    Stream B: WBC Candidates    Metadata
(Batch: NÃ—128Ã—128Ã—3)        (Batch: MÃ—224Ã—224Ã—3)        (Coords, IDs)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STAGE 4: DUAL CLASSIFICATION SYSTEMS                           â”‚
â”‚                      (The "Specialized" Layer)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Rationale: Separate classifiers allow different architectures suited for each cell type

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PIPELINE A: RBC CLASSIFIER                                 â”‚
â”‚                         (Morphology Focus)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Task: Classify RBCs by morphology and pathology                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Classes (Example - Customizable):                       â”‚    â”‚
â”‚  â”‚   1. Normal RBC (biconcave disc)                        â”‚    â”‚
â”‚  â”‚   2. Macrocytic (abnormally large)                      â”‚    â”‚
â”‚  â”‚   3. Microcytic (abnormally small)                      â”‚    â”‚
â”‚  â”‚   4. Sickle Cell (crescent-shaped)                      â”‚    â”‚
â”‚  â”‚   5. Target Cell (bullseye appearance)                  â”‚    â”‚
â”‚  â”‚   6. Spherocyte (spherical, no central pallor)          â”‚    â”‚
â”‚  â”‚   7. Echinocyte (spiky/burr cells)                      â”‚    â”‚
â”‚  â”‚   8. Malaria-infected (Plasmodium parasites visible)    â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Diagnostic Criteria:                                     â”‚    â”‚
â”‚  â”‚   â€¢ Shape: circular vs. distorted                       â”‚    â”‚
â”‚  â”‚   â€¢ Size: diameter relative to normal                   â”‚    â”‚
â”‚  â”‚   â€¢ Texture: smooth vs. granular                        â”‚    â”‚
â”‚  â”‚   â€¢ Color: uniform vs. non-uniform staining             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Model Architecture: EfficientNet-V2 (Small) or ResNet-50         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Why These Architectures?                                â”‚    â”‚
â”‚  â”‚   â€¢ RBC classification relies on shape & texture        â”‚    â”‚
â”‚  â”‚   â€¢ CNNs excel at texture extraction                    â”‚    â”‚
â”‚  â”‚   â€¢ Efficient inference (100+ cells/second)             â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Model Structure:                                         â”‚    â”‚
â”‚  â”‚   Input: (128, 128, 3) RGB crop                         â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Backbone: EfficientNet-V2-S                           â”‚    â”‚
â”‚  â”‚     â€¢ Fused-MBConv blocks                               â”‚    â”‚
â”‚  â”‚     â€¢ Progressive learning                              â”‚    â”‚
â”‚  â”‚     â€¢ ~21M parameters                                   â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Features: (4, 4, 1280)                                â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Global Average Pooling                                â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Dense(512, ReLU)                                      â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Dropout(0.3)                                          â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Dense(num_classes, softmax)                           â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Output: Probability distribution over RBC types      â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Training Strategy:                                       â”‚    â”‚
â”‚  â”‚   â€¢ Transfer learning from ImageNet                     â”‚    â”‚
â”‚  â”‚   â€¢ Fine-tune last 30% of layers                        â”‚    â”‚
â”‚  â”‚   â€¢ Data augmentation: rotation, flip, color jitter     â”‚    â”‚
â”‚  â”‚   â€¢ Class balancing: weighted loss or oversampling      â”‚    â”‚
â”‚  â”‚   â€¢ Learning rate: 1e-4 with cosine decay               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input/Output Specifications:                                     â”‚
â”‚   â€¢ Input Size: 64Ã—64 or 128Ã—128 (configurable)                 â”‚
â”‚   â€¢ Input Format: RGB float32 [0, 1]                             â”‚
â”‚   â€¢ Batch Size: 64-128 (efficient processing)                    â”‚
â”‚   â€¢ Output: (batch_size, num_rbc_classes)                        â”‚
â”‚   â€¢ Inference Time: ~2ms per cell (GPU)                          â”‚
â”‚   â€¢ Expected Accuracy: 90-95% (with good data)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PIPELINE B: WBC CLASSIFIER                                 â”‚
â”‚                      (Fine-grained Feature Focus)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Task: Classify WBCs into subtypes (Differential Count)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Classes (Standard Leukocyte Types):                     â”‚    â”‚
â”‚  â”‚   1. Neutrophil (50-70% of WBCs)                        â”‚    â”‚
â”‚  â”‚      â€¢ Multi-lobed nucleus                              â”‚    â”‚
â”‚  â”‚      â€¢ Fine granules                                    â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   2. Eosinophil (1-4% of WBCs)                          â”‚    â”‚
â”‚  â”‚      â€¢ Bi-lobed nucleus                                 â”‚    â”‚
â”‚  â”‚      â€¢ Large orange-red granules                        â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   3. Basophil (<1% of WBCs)                             â”‚    â”‚
â”‚  â”‚      â€¢ Obscured nucleus                                 â”‚    â”‚
â”‚  â”‚      â€¢ Large blue-purple granules                       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   4. Monocyte (2-10% of WBCs)                           â”‚    â”‚
â”‚  â”‚      â€¢ Kidney-shaped nucleus                            â”‚    â”‚
â”‚  â”‚      â€¢ Large cell, gray-blue cytoplasm                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   5. Lymphocyte (20-40% of WBCs)                        â”‚    â”‚
â”‚  â”‚      â€¢ Round, large nucleus                             â”‚    â”‚
â”‚  â”‚      â€¢ Scant cytoplasm                                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   6. Blast (Immature - Abnormal)                        â”‚    â”‚
â”‚  â”‚      â€¢ Immature precursor cell                          â”‚    â”‚
â”‚  â”‚      â€¢ Large nucleus with nucleoli                      â”‚    â”‚
â”‚  â”‚      â€¢ Indicator of leukemia                            â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Diagnostic Criteria:                                     â”‚    â”‚
â”‚  â”‚   â€¢ Nucleus shape & lobulation                          â”‚    â”‚
â”‚  â”‚   â€¢ Granularity (type and color)                        â”‚    â”‚
â”‚  â”‚   â€¢ Cytoplasm volume & color                            â”‚    â”‚
â”‚  â”‚   â€¢ Nuclear-cytoplasmic ratio                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Model Architecture: ConvNeXt or Vision Transformer (ViT-Tiny)    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Why These Architectures?                                â”‚    â”‚
â”‚  â”‚   â€¢ WBC differentiation requires fine-grained features  â”‚    â”‚
â”‚  â”‚   â€¢ Subtle differences in nucleus shape & granules      â”‚    â”‚
â”‚  â”‚   â€¢ Transformers excel at capturing global patterns     â”‚    â”‚
â”‚  â”‚   â€¢ Better performance on fine-grained tasks            â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Option A: ConvNeXt-Tiny (Recommended)                   â”‚    â”‚
â”‚  â”‚   Input: (224, 224, 3) RGB crop                         â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Stem: 4Ã—4 conv, stride 4                              â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Stage 1: 3 ConvNeXt blocks (96 channels)             â”‚    â”‚
â”‚  â”‚   Stage 2: 3 blocks (192 channels)                      â”‚    â”‚
â”‚  â”‚   Stage 3: 9 blocks (384 channels)                      â”‚    â”‚
â”‚  â”‚   Stage 4: 3 blocks (768 channels)                      â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Global Average Pooling                                â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Layer Normalization                                   â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Dense(num_classes, softmax)                           â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Output: WBC type probabilities                        â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   Parameters: ~28M                                      â”‚    â”‚
â”‚  â”‚   Advantages:                                            â”‚    â”‚
â”‚  â”‚     â€¢ Better than ResNet on fine-grained tasks          â”‚    â”‚
â”‚  â”‚     â€¢ Efficient training                                â”‚    â”‚
â”‚  â”‚     â€¢ Good accuracy/speed tradeoff                      â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Option B: Vision Transformer (ViT-Tiny)                 â”‚    â”‚
â”‚  â”‚   Input: (224, 224, 3) â†’ Patches (16Ã—16)                â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Patch Embedding: Linear projection                    â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Position Embedding: Learned                           â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Transformer Encoder (12 layers):                      â”‚    â”‚
â”‚  â”‚     â€¢ Multi-head self-attention (12 heads)              â”‚    â”‚
â”‚  â”‚     â€¢ MLP with GELU activation                          â”‚    â”‚
â”‚  â”‚     â€¢ Layer normalization                               â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   [CLS] Token â†’ Classification Head                     â”‚    â”‚
â”‚  â”‚      â†“                                                   â”‚    â”‚
â”‚  â”‚   Dense(num_classes, softmax)                           â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   Parameters: ~5M                                       â”‚    â”‚
â”‚  â”‚   Advantages:                                            â”‚    â”‚
â”‚  â”‚     â€¢ Best accuracy on complex patterns                 â”‚    â”‚
â”‚  â”‚     â€¢ Captures global relationships                     â”‚    â”‚
â”‚  â”‚     â€¢ Requires more training data                       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Training Strategy:                                       â”‚    â”‚
â”‚  â”‚   â€¢ Pretrain on large WBC dataset                       â”‚    â”‚
â”‚  â”‚   â€¢ Fine-tune on lab-specific data                      â”‚    â”‚
â”‚  â”‚   â€¢ Heavy augmentation (WBCs are rare)                  â”‚    â”‚
â”‚  â”‚   â€¢ Focal loss for class imbalance                      â”‚    â”‚
â”‚  â”‚   â€¢ Test-time augmentation for robustness               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input/Output Specifications:                                     â”‚
â”‚   â€¢ Input Size: 224Ã—224 (higher res needed for detail)          â”‚
â”‚   â€¢ Input Format: RGB float32 [0, 1]                             â”‚
â”‚   â€¢ Batch Size: 16-32 (larger images)                            â”‚
â”‚   â€¢ Output: (batch_size, num_wbc_classes)                        â”‚
â”‚   â€¢ Inference Time: ~10ms per cell (GPU)                         â”‚
â”‚   â€¢ Expected Accuracy: 92-97% (with good data)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Async Batching Strategy (Performance Optimization)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Problem: Different batch sizes and processing times     â”‚    â”‚
â”‚  â”‚ Solution: Asynchronous pipeline with queues             â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Architecture:                                            â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   RBC Queue â”€â”€â”                                          â”‚    â”‚
â”‚  â”‚               â”œâ”€â”€â–º RBC Batch Worker (GPU 0)             â”‚    â”‚
â”‚  â”‚   RBC Queue â”€â”€â”˜     â€¢ Process 128 RBCs at once          â”‚    â”‚
â”‚  â”‚                     â€¢ 2ms Ã— 128 = 256ms total            â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   WBC Queue â”€â”€â”                                          â”‚    â”‚
â”‚  â”‚               â”œâ”€â”€â–º WBC Batch Worker (GPU 1)             â”‚    â”‚
â”‚  â”‚   WBC Queue â”€â”€â”˜     â€¢ Process 32 WBCs at once           â”‚    â”‚
â”‚  â”‚                     â€¢ 10ms Ã— 32 = 320ms total            â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Benefits:                                                â”‚    â”‚
â”‚  â”‚   â€¢ 5-10Ã— faster than sequential processing             â”‚    â”‚
â”‚  â”‚   â€¢ Better GPU utilization                              â”‚    â”‚
â”‚  â”‚   â€¢ Handles different cell counts elegantly             â”‚    â”‚
â”‚  â”‚   â€¢ Can scale to multiple GPUs                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STAGE 5: RESULT AGGREGATION & OUTPUT                           â”‚
â”‚                         (The "Assembly" Layer)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5.1 De-duplication (Non-Maximum Suppression - NMS)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Problem: Same cell detected in overlapping tiles        â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Solution: NMS Algorithm                                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Algorithm:                                               â”‚    â”‚
â”‚  â”‚   1. Sort all detections by confidence (descending)     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   2. For each detection D:                              â”‚    â”‚
â”‚  â”‚      a) If D already marked as duplicate, skip          â”‚    â”‚
â”‚  â”‚      b) Add D to final results                          â”‚    â”‚
â”‚  â”‚      c) For all remaining detections R:                 â”‚    â”‚
â”‚  â”‚         â€¢ Calculate IoU(D, R)                           â”‚    â”‚
â”‚  â”‚         â€¢ If IoU > threshold (0.5):                     â”‚    â”‚
â”‚  â”‚           - Mark R as duplicate                         â”‚    â”‚
â”‚  â”‚           - Keep D (higher confidence)                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ IoU Calculation:                                         â”‚    â”‚
â”‚  â”‚   IoU = Area(D âˆ© R) / Area(D âˆª R)                       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Parameters:                                              â”‚    â”‚
â”‚  â”‚   â€¢ IoU threshold: 0.5 (50% overlap = same cell)        â”‚    â”‚
â”‚  â”‚   â€¢ Consider global coordinates across tiles            â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ Result: Unique cell detections only                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5.2 Count Statistics & Ratios                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Calculate Clinical Metrics:                             â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ A) Basic Counts:                                         â”‚    â”‚
â”‚  â”‚    â€¢ Total RBCs detected                                â”‚    â”‚
â”‚  â”‚    â€¢ Total WBCs detected                                â”‚    â”‚
â”‚  â”‚    â€¢ RBC/WBC ratio (typically 500:1 to 1000:1)          â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ B) RBC Morphology Distribution:                          â”‚    â”‚
â”‚  â”‚    â€¢ % Normal RBCs                                      â”‚    â”‚
â”‚  â”‚    â€¢ % Microcytic                                       â”‚    â”‚
â”‚  â”‚    â€¢ % Macrocytic                                       â”‚    â”‚
â”‚  â”‚    â€¢ % Sickle cells                                     â”‚    â”‚
â”‚  â”‚    â€¢ % Other abnormalities                              â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ C) WBC Differential Count:                               â”‚    â”‚
â”‚  â”‚    â€¢ % Neutrophils (normal: 50-70%)                     â”‚    â”‚
â”‚  â”‚    â€¢ % Lymphocytes (normal: 20-40%)                     â”‚    â”‚
â”‚  â”‚    â€¢ % Monocytes (normal: 2-10%)                        â”‚    â”‚
â”‚  â”‚    â€¢ % Eosinophils (normal: 1-4%)                       â”‚    â”‚
â”‚  â”‚    â€¢ % Basophils (normal: <1%)                          â”‚    â”‚
â”‚  â”‚    â€¢ Blast count (abnormal if present)                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ D) Clinical Ratios:                                      â”‚    â”‚
â”‚  â”‚    â€¢ M:E Ratio (Myeloid:Erythroid)                      â”‚    â”‚
â”‚  â”‚    â€¢ Left Shift Index (immature cells)                  â”‚    â”‚
â”‚  â”‚    â€¢ Abnormality Flags                                  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ E) Quality Metrics:                                      â”‚    â”‚
â”‚  â”‚    â€¢ Average detection confidence                       â”‚    â”‚
â”‚  â”‚    â€¢ Number of uncertain cases (confidence < 0.7)       â”‚    â”‚
â”‚  â”‚    â€¢ Image quality score                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5.3 JSON Payload Construction                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Structured Output Format:                               â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ {                                                        â”‚    â”‚
â”‚  â”‚   "image_id": "LAB_001_SLIDE_2024",                     â”‚    â”‚
â”‚  â”‚   "timestamp": "2025-11-25T10:30:00Z",                  â”‚    â”‚
â”‚  â”‚   "processing_time_seconds": 45.3,                      â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   "summary": {                                           â”‚    â”‚
â”‚  â”‚     "total_cells": 8475,                                â”‚    â”‚
â”‚  â”‚     "rbc_count": 8350,                                  â”‚    â”‚
â”‚  â”‚     "wbc_count": 125,                                   â”‚    â”‚
â”‚  â”‚     "rbc_wbc_ratio": 66.8,                              â”‚    â”‚
â”‚  â”‚     "image_quality": "good"                             â”‚    â”‚
â”‚  â”‚   },                                                     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   "rbc_analysis": {                                      â”‚    â”‚
â”‚  â”‚     "total": 8350,                                      â”‚    â”‚
â”‚  â”‚     "distribution": {                                    â”‚    â”‚
â”‚  â”‚       "normal": 7980,      // 95.6%                     â”‚    â”‚
â”‚  â”‚       "microcytic": 180,   // 2.2%                      â”‚    â”‚
â”‚  â”‚       "macrocytic": 120,   // 1.4%                      â”‚    â”‚
â”‚  â”‚       "sickle": 40,        // 0.5%                      â”‚    â”‚
â”‚  â”‚       "other": 30          // 0.3%                      â”‚    â”‚
â”‚  â”‚     },                                                   â”‚    â”‚
â”‚  â”‚     "abnormality_rate": 4.4,  // percentage            â”‚    â”‚
â”‚  â”‚     "flags": ["microcytosis_detected"]                  â”‚    â”‚
â”‚  â”‚   },                                                     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   "wbc_differential": {                                  â”‚    â”‚
â”‚  â”‚     "total": 125,                                       â”‚    â”‚
â”‚  â”‚     "distribution": {                                    â”‚    â”‚
â”‚  â”‚       "neutrophil": 70,    // 56.0%                     â”‚    â”‚
â”‚  â”‚       "lymphocyte": 35,    // 28.0%                     â”‚    â”‚
â”‚  â”‚       "monocyte": 12,      // 9.6%                      â”‚    â”‚
â”‚  â”‚       "eosinophil": 6,     // 4.8%                      â”‚    â”‚
â”‚  â”‚       "basophil": 1,       // 0.8%                      â”‚    â”‚
â”‚  â”‚       "blast": 1           // 0.8% âš ï¸ ABNORMAL          â”‚    â”‚
â”‚  â”‚     },                                                   â”‚    â”‚
â”‚  â”‚     "flags": [                                           â”‚    â”‚
â”‚  â”‚       "blast_detected",                                 â”‚    â”‚
â”‚  â”‚       "possible_leukemia"                               â”‚    â”‚
â”‚  â”‚     ]                                                    â”‚    â”‚
â”‚  â”‚   },                                                     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   "cell_detections": [                                   â”‚    â”‚
â”‚  â”‚     {                                                    â”‚    â”‚
â”‚  â”‚       "cell_id": 1,                                     â”‚    â”‚
â”‚  â”‚       "type": "rbc",                                    â”‚    â”‚
â”‚  â”‚       "classification": "normal",                       â”‚    â”‚
â”‚  â”‚       "confidence": 0.987,                              â”‚    â”‚
â”‚  â”‚       "bbox": [1024, 512, 1088, 576],                   â”‚    â”‚
â”‚  â”‚       "centroid": [1056, 544]                           â”‚    â”‚
â”‚  â”‚     },                                                   â”‚    â”‚
â”‚  â”‚     // ... (8474 more cells)                            â”‚    â”‚
â”‚  â”‚   ],                                                     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   "uncertain_cases": [                                   â”‚    â”‚
â”‚  â”‚     {                                                    â”‚    â”‚
â”‚  â”‚       "cell_id": 452,                                   â”‚    â”‚
â”‚  â”‚       "type": "wbc",                                    â”‚    â”‚
â”‚  â”‚       "predicted_class": "blast",                       â”‚    â”‚
â”‚  â”‚       "confidence": 0.62,                               â”‚    â”‚
â”‚  â”‚       "reason": "low_confidence",                       â”‚    â”‚
â”‚  â”‚       "requires_manual_review": true                    â”‚    â”‚
â”‚  â”‚     }                                                    â”‚    â”‚
â”‚  â”‚   ],                                                     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚   "quality_metrics": {                                   â”‚    â”‚
â”‚  â”‚     "avg_confidence": 0.923,                            â”‚    â”‚
â”‚  â”‚     "stain_quality": "good",                            â”‚    â”‚
â”‚  â”‚     "focus_quality": "excellent",                       â”‚    â”‚
â”‚  â”‚     "coverage": 0.87  // 87% of slide analyzed         â”‚    â”‚
â”‚  â”‚   }                                                      â”‚    â”‚
â”‚  â”‚ }                                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5.4 Report Generation                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Output Formats:                                          â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 1. JSON Report (Machine-readable)                       â”‚    â”‚
â”‚  â”‚    â€¢ Full structured data                               â”‚    â”‚
â”‚  â”‚    â€¢ All cell detections                                â”‚    â”‚
â”‚  â”‚    â€¢ For downstream analysis/database storage           â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 2. PDF Report (Human-readable)                          â”‚    â”‚
â”‚  â”‚    â€¢ Executive summary                                  â”‚    â”‚
â”‚  â”‚    â€¢ Key findings and flags                             â”‚    â”‚
â”‚  â”‚    â€¢ Visualization: cell distribution charts            â”‚    â”‚
â”‚  â”‚    â€¢ Annotated image with highlighted cells             â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 3. HL7/FHIR Message (Clinical Integration)              â”‚    â”‚
â”‚  â”‚    â€¢ Standard healthcare format                         â”‚    â”‚
â”‚  â”‚    â€¢ Integrates with LIS/HIS systems                    â”‚    â”‚
â”‚  â”‚    â€¢ Includes patient metadata                          â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ 4. Visualization Overlays                                â”‚    â”‚
â”‚  â”‚    â€¢ Annotated original image                           â”‚    â”‚
â”‚  â”‚    â€¢ Color-coded bounding boxes                         â”‚    â”‚
â”‚  â”‚    â€¢ Confidence scores displayed                        â”‚    â”‚
â”‚  â”‚    â€¢ Abnormal cells highlighted                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SYSTEM PERFORMANCE METRICS                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

End-to-End Performance:
â”œâ”€ Input: 40kÃ—40k WSI image
â”œâ”€ Processing Time: 2-5 minutes (GPU)
â”œâ”€ Throughput: 100-200 cells/second
â”œâ”€ Accuracy: 
â”‚  â”œâ”€ Segmentation: >95% (detection rate)
â”‚  â”œâ”€ RBC Classification: 90-95%
â”‚  â””â”€ WBC Classification: 92-97%
â”œâ”€ False Positive Rate: <5%
â”œâ”€ False Negative Rate: <10%
â””â”€ Clinical Agreement: 85-90% (vs. expert hematologist)

Resource Requirements:
â”œâ”€ GPU Memory: 8-12 GB (NVIDIA RTX 3080 or better)
â”œâ”€ CPU: 8+ cores for preprocessing
â”œâ”€ RAM: 32 GB recommended
â”œâ”€ Storage: ~1 GB per WSI (temporary)
â””â”€ Network: 100 Mbps for API communication


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      KEY ARCHITECTURAL DECISIONS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Why Stain Normalization at the Beginning?
   âœ“ Prevents domain shift from affecting all downstream models
   âœ“ Single normalization step, not repeated at each model
   âœ“ 15-20% improvement in cross-lab generalization
   âœ— Alternative: Domain adaptation in each model (more complex)

2. Why Instance Segmentation over Semantic?
   âœ“ Separates touching/overlapping cells accurately
   âœ“ Provides individual cell counts (critical for diagnostics)
   âœ“ Enables per-cell classification downstream
   âœ— Standard U-Net would merge touching RBCs into blobs

3. Why Separate RBC and WBC Classifiers?
   âœ“ Different biological complexity requires different architectures
   âœ“ RBCs: simple CNN (shape/texture) - fast & efficient
   âœ“ WBCs: transformer (fine details) - accurate on subtle patterns
   âœ“ Allows independent optimization and scaling
   âœ— Single classifier would be suboptimal for both

4. Why Overlapping Tiles with NMS?
   âœ“ Prevents missing cells at tile boundaries
   âœ“ NMS efficiently removes duplicates
   âœ“ Better than exact tiling (which cuts cells)
   âœ— Slight computational overhead (worth the accuracy gain)

5. Why Async Batching?
   âœ“ 5-10Ã— faster than sequential processing
   âœ“ Better GPU utilization (keeps GPU busy)
   âœ“ Handles variable cell counts gracefully
   âœ— Adds architectural complexity (worth it for production)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DEPLOYMENT ARCHITECTURE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Production Deployment Stack:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Layer (Hospital/Lab)                                      â”‚
â”‚   â€¢ Web interface (React/Vue.js)                                 â”‚
â”‚   â€¢ Image upload & queue management                              â”‚
â”‚   â€¢ Report viewer with interactive annotations                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ HTTPS/REST API
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Gateway (FastAPI/Flask)                                      â”‚
â”‚   â€¢ Authentication & authorization                               â”‚
â”‚   â€¢ Request validation & rate limiting                           â”‚
â”‚   â€¢ Job queue management (Redis)                                 â”‚
â”‚   â€¢ Load balancing across inference servers                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Preprocessing Service (Celery Workers)                           â”‚
â”‚   â€¢ Stain normalization                                          â”‚
â”‚   â€¢ Adaptive tiling                                              â”‚
â”‚   â€¢ Quality checks                                               â”‚
â”‚   â€¢ Distributes tiles to inference nodes                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                    â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Inference   â”‚  â”‚ Inference   â”‚  â”‚ Inference   â”‚
â”‚ Node 1      â”‚  â”‚ Node 2      â”‚  â”‚ Node 3      â”‚
â”‚ (GPU)       â”‚  â”‚ (GPU)       â”‚  â”‚ (GPU)       â”‚
â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â”‚ Segment +   â”‚  â”‚ Segment +   â”‚  â”‚ Segment +   â”‚
â”‚ Classify    â”‚  â”‚ Classify    â”‚  â”‚ Classify    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                    â”‚                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Aggregation Service                                              â”‚
â”‚   â€¢ Collect results from all inference nodes                     â”‚
â”‚   â€¢ Apply NMS for de-duplication                                 â”‚
â”‚   â€¢ Calculate statistics & generate reports                      â”‚
â”‚   â€¢ Quality assurance checks                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database & Storage                                               â”‚
â”‚   â€¢ PostgreSQL (metadata, reports)                               â”‚
â”‚   â€¢ S3/MinIO (images, visualizations)                            â”‚
â”‚   â€¢ Elasticsearch (search & analytics)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Containerization:
â”œâ”€ Docker containers for each service
â”œâ”€ Kubernetes for orchestration & scaling
â”œâ”€ Horizontal scaling based on load
â””â”€ GPU node pool for inference workers


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ERROR HANDLING & ROBUSTNESS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Failure Modes & Mitigations:

1. Poor Image Quality
   Detection: Focus/blur detection (Laplacian variance)
   Action: Flag as "low_quality", request re-scan
   
2. Stain Variation Beyond Normalization Capacity
   Detection: Color distribution analysis
   Action: Use domain adaptation branch, flag for review
   
3. Extremely High Cell Density (clumping)
   Detection: Watershed segmentation failure
   Action: Apply morphological operations, flag uncertain regions
   
4. Out-of-Distribution Cell Types
   Detection: Low confidence scores across all classes
   Action: Flag as "unknown", route to expert review
   
5. GPU Out-of-Memory
   Detection: CUDA error handling
   Action: Dynamic batch size reduction, retry
   
6. Model Inference Timeout
   Detection: Timeout monitoring
   Action: Distribute work across multiple GPUs

Quality Assurance Pipeline:
â”œâ”€ Automatic QC checks at each stage
â”œâ”€ Confidence thresholds for flagging
â”œâ”€ Expert review queue for uncertain cases
â”œâ”€ Continuous monitoring & drift detection
â””â”€ Regular model retraining with new data


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FUTURE ENHANCEMENTS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Active Learning Pipeline
   â€¢ Automatically identify uncertain cases
   â€¢ Route to experts for annotation
   â€¢ Retrain models with new labeled data
   â€¢ Continuous improvement loop

2. Multi-Modal Fusion
   â€¢ Combine brightfield + fluorescence imaging
   â€¢ Integrate clinical metadata (patient history)
   â€¢ Improve diagnostic accuracy with context

3. Explainable AI
   â€¢ Grad-CAM visualizations (what model is looking at)
   â€¢ Attention maps for interpretability
   â€¢ Build trust with clinicians

4. Real-Time Processing
   â€¢ Optimize for <30 second turnaround
   â€¢ Edge deployment for point-of-care
   â€¢ Mobile app integration

5. Rare Disease Detection
   â€¢ Expand to rare blood disorders
   â€¢ Train on larger, more diverse datasets
   â€¢ Collaborate with medical institutions


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 LEGEND                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Symbols:
â”œâ”€ â”€â”€â–º : Data flow / Processing direction
â”œâ”€ â–¼   : Vertical flow
â”œâ”€ â—„â”€â”€ : Feedback / Return flow
â”œâ”€ â”œâ”€  : Tree structure / Hierarchy
â””â”€ â””â”€  : End of branch

Annotations:
â”œâ”€ âœ“ : Advantage / Benefit
â”œâ”€ âœ— : Disadvantage / Alternative rejected
â”œâ”€ â˜… : Critical component / Highly recommended
â”œâ”€ âš ï¸ : Warning / Attention required
â””â”€ â€¢ : List item / Detail

Components:
â”œâ”€ â”Œâ”€â” : Processing module
â”œâ”€ â”‚ â”‚ : Container boundary
â””â”€ â””â”€â”˜ : End of container
```

---

**Document Version**: 1.0  
**Architecture Type**: Production-Grade Clinical Pipeline  
**Target Use Case**: Hospital/Laboratory Blood Analysis  
**Last Updated**: November 25, 2025  
**License**: MIT
